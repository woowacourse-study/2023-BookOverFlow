# 4장

## 상태 코드는 서버로부터 리퀘스트 결과를 전달한다
- 상태 코드의 역할은 리퀘스트를 보낼 때 서버에서 그 결과가 어떻게 되었는지 알려주는 것이다.
- 상태 코드는 3자리 숫자와 설명으로 나타낸다.
- 숫자의 첫 번째 자리는 리스폰스의 클래스를 의미하고 나머지 두 자리는 분류가 없다.
- 리스폰스 클래스는 5개가 정의되어 있다.
  - 1XX | Informational | 리퀘스트를 받아들여 처리중
  - 2XX | Success | 리퀘스트를 정상적으로 처리함
  - 3XX | Redirection | 리퀘스트를 완료하기 위해 추가 동작이 필요
  - 4XX | Client Error | 서버가 리퀘스트 이해 불가능
  - 5XX | Server Error | 서버가 리퀘스트 처리 실패
- 클래스의 정의만 지키면 상태 코드를 변경하거나 서버 자체의 상태 코드를 만들어도 상관없다.

<br>

## 성공
- 2XX 리스폰스는 리퀘스트가 정상으로 처리되었음을 나타낸다.
- **200 OK**
  - 리퀘스트를 서버가 정상 처리했음을 나타낸다.
  - 상태 코드와 함께 되돌아오는 정보는 메소드에 따라 다르다.
  - GET 메소드인 경우 리퀘스트된 리소스에 대응하는 엔티티가 리스폰스로 보내지고, HEAD 메소드의 경우 리퀘스트된 리소스에 대응하는 엔티티 헤더 필드가 메시지 없이 리스폰스로 반환된다.
- **204 No Content**
  - 서버가 리퀘스트를 받아서 처리하는 데는 성공했지만 리스폰스에 엔티티 바디를 포함하지 않는다.
  - 엔티티 바디를 되돌려주면 안된다.
  - 클라이언트에서 서버에 정보를 보내는 것으로 족하고, 클라이언트에 대해 새로운 정보를 보낼 필요가 없는 경우에 사용한다.
- **206 Partial Content**
  - Range에 의해 범위가 지정된 리퀘스트에 의해 서버가 부분적 GET 리퀘스트를 받았음을 나타낸다.
  - 리스폰스에는 Content-Range로 지정된 범위의 엔티티가 포함된다.

<br>

## 리다이렉트
- 3XX 리스폰스는 리퀘스트가 정상적으로 처리를 종료하기 위해 브라우저 측에서 특별한 처리를 수행해야 함을 나타낸다.
- **301 Moved Permanently**
  - 리퀘스트된 리소스에는 새로운 URI가 부여되어 있기 때문에 이후로는 그 리소스를 참조하는 URI를 사용해야 한다는 것을 나타낸다.
  - 북마크를 하고 있는 경우 Location 헤더 필드에서 가리키고 있는 URI에 북마크를 다시 하는게 좋다는 것을 나타낸다. 
  - "/data"라는 URL를 통해 요청을 보낼 때 "/data"는 더이상 사용되지 않아! 앞으로는 "/new-data"로 요청해야 해! 라고 알려주기 위해 301 상태 코드와 Location 헤더에 새로운 URL인 "/new-data"를 담아 응답 메시지를 보낸다.
  - GET 메서드는 변경되지 않는다. 다른 메서드들은 GET으로 변할수도, 변하지 않을 수도 있다.
- **302 Found**
  - 리퀘스트된 리소스에는 새로운 URI가 할당되어 있기 때문에 그 URI를 참조하길 바란다는 의미를 담고 있다.
  - 301과 비슷하지만 302는 영구적인 이동이 아닌, 일시적인 이동이다.
  - GET 메서드는 변경되지 않는다. 다른 메서드들은 GET으로 변할수도, 변하지 않을 수도 있다. 이러한 불확실성 때문에 303, 307 상태 코드가 추가되었다. 그래서 만약 사용된 메서드를 GET으로 변경하려는 경우 302 대신 303 See Other를 사용하는 것이 좋다.
- **303 See Other**
  - 리퀘스트에 대한 리소스는 다른 URI에 있기 때문에 GET 메소드를 사용해서 얻어야 한다는 것을 나타낸다.
  - 302와 같은 기능이지만, 리다이렉트 장소를 GET 메소드로 얻어야 한다고 명확하게 되어있는 점이 다르다.
  - GET 메서드는 변경되지 않는다. 다른 메서드들은 GET으로 무조건 변경된다. (이를 통해 바디를 잃는다.)
> 301, 302, 303 리스폰스 코드가 되돌아오면, 대부분의 브라우저에서는 POST를 GET으로 바꾸어서 리퀘스트의 엔티티 바디를 삭제하고 리퀘스트를 자동적으로 재송신하도록 되어있다.
> 301, 302의 사양은 POST 메소드를 GET으로 바꾸는 것을 금지하고 있지만 구현해 놓은 것을 보면 대부분 이렇게 되어있다.

- **304 Not Modified**
  - 클라이언트가 조건부 리퀘스트를 했을 때 리소스에 대한 액세스는 허락하지만, 조건이 충족되지 않음을 표시한다.
  - 304를 돌려줄 때는 바디에는 아무 값도 없어야 한다.
  - 리다이렉트와는 관련이 없다.

- **307 Temporary Redirect**
  - 메서드와 바디는 변경되지 않는다.
  - 웹 페이지가 예측하지 못한 이유로 일시적으로 이용이 불가능한 경우 재요청을 하기 위함이다.

<br>

## 클라이언트 에러
- 4XX 리스폰스는 클라이언트의 원인으로 에러가 발생했음을 나타낸다.
- **400 Bad Request**
  - 리퀘스트 구문이 잘못되었음을 나타낸다.
  - 브라우저는 이를 200 OK와 같이 취급한다.
- **401 Unauthorized**
  - 리퀘스트에 HTTP 인증(BASIC 인증..)이 필요하다는 것을 나타낸다.
- **403 Forbidden**
  - 리퀘스트된 리소스의 액세스가 거부되었음을 나타낸다.
  - 403이 발생한 원인으로는 파일 시스템의 퍼미션이 부여되지 않은 경우와 액세스 권한에 문제(허가되지 않은 송신 IP주소의 액세스) 등이 있다.
- **404 Not Found**
  - 리퀘스트한 리소스가 서버상에 없다는 것을 나타낸다.

<br>

## 서버 에러
- 5XX 리스폰스는 서버 원인으로 에러가 발생하고 있음을 나타낸다.
- **500 Internal Server Error**
  - 서버에서 리퀘스트를 처리하는 도중 에러가 발생했음을 나타낸다.
  - 웹 애플리케이션에 에러가 발생한 경우나 일시적인 경우도 있다.
- **503 Service Unavailable**
  - 서버가 과부하 상태이거나 점검중이기 때문에 현재 리퀘스트를 처리할 수 없음을 나타낸다.

> 상태 코드가 현재 상황가 불일치할 수도 있다.
> 리스폰스로 되돌아오는 상태 코드의 대부분은 유저가 다른 내용을 알기 어렵게 되어 있다. 흔히 있는 상황으로 웹 애플리케이션에서 애플리케이션 에러가 발생한 경우에도 상태 코드로는 [200 OK]가 되돌아오는 경우도 있다.

<br>

## 궁금한 점
- 301, 302 모두 리다이렉션 후 요청 메서드를 GET으로 변경하도록 해두었을까?  
쇼핑 사이트에서 POST를 통해 주문을 요청하고 브라우저를 새로고침한 경우를 생각해보자. 새로고침은 이전의 요청을 재전송하기 때문에 POST 요청을 다시 할 것이고, 서버에 중복 주문이 들어갈 수도 있다.  

<center>
<img width="700" src="https://github.com/woowacourse-teams/2023-naaga/assets/84285337/41f9543a-4989-4703-bf13-dd56aa6cda75">
</center>
일반적인 상황에서는 다음과 같이 진행될 것이다.  

1. 클라이언트에서 mouse제품의 수량을 1개로 선택하여 POST 메서드로 주문을 요청한다.  
2. 서버에서는 주문 요청을 데이터베이스에 저장한다.  
3. 200 OK 를 반환한다.  
4. 브라우저를 새로고침한다.  
5. 새로고침되면서 이전 POST 요청이 똑같이 한 번 더 전송되고, 같은 주문이 반복된다.  

이는 이전에 보냈던 POST메서드를 GET으로 변환시켜 해결할 수 있다. 위 예시에서 302 상태 코드를 적용하면 다음과 같이 변경된다.

<br>

<center>
<img width="700" src="https://github.com/woowacourse-teams/2023-naaga/assets/84285337/4a82e7e7-f8aa-4fb4-b826-870791306d14">
</center>  

1. 사용자는 mouse제품의 수량을 1개로 선택하여 POST 메서드로 주문을 요청한다.  
2. 서버에서는 주문 요청을 데이터베이스에 저장한다.  
3. 리다이렉트할 Location 헤더와 함께 302 Found를 반환한다.  
4. 클라이언트는 Location 헤더에 담긴 URL로 요청을 한다. 이 때 메서드를 GET으로 변경하고 body를 제거한다. 클라이언트는 자연스럽게 조회 요청을 날리는 것이다.  
5. 서버는 데이터베이스에서 해당 주문을 조회한다.  
6. 200 OK 를 반환한다.  
7. 주문 결과 화면으로 이동한 클라이언트는 새로고침을 하더라도 조회 요청만을 반복적으로 한다.(5번)  

이렇게 PRG(Post Redirect Get) 패턴이 적용된 적절한 상태코드를 사용하여 문제를 해결할 수 있다.

<br><br>

참고
- [mdn HTTP 리다이렉트](https://developer.mozilla.org/ko/docs/Web/HTTP/Redirections#%EC%9C%A0%EC%8A%A4_%EC%BC%80%EC%9D%B4%EC%8A%A4)
- https://inpa.tistory.com/entry/HTTP-%F0%9F%8C%90-3XX-Redirection-%EC%83%81%ED%83%9C-%EC%BD%94%EB%93%9C-%EC%A0%9C%EB%8C%80%EB%A1%9C-%EC%95%8C%EC%95%84%EB%B3%B4%EA%B8%B0