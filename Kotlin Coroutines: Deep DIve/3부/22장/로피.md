# 22ì¥ í”Œë¡œìš° ìƒëª…ì£¼ê¸° í•¨ìˆ˜

í”Œë¡œìš°

- ìš”ì²­ì´ í•œìª½ ë°©í–¥ìœ¼ë¡œ íë¥´ê³  ìš”ì²­ì— ì˜í•´ ìƒì„±ëœ ê°’ì´ ë‹¤ë¥¸ ë°©í–¥ìœ¼ë¡œ íë¥´ëŠ” íŒŒì´í”„ë¼ ìƒê°í•  ìˆ˜ ìˆë‹¤.
- ì™„ë£Œë˜ê±°ë‚˜ ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ, ì´ëŸ¬í•œ ì •ë³´ê°€ ì „ë‹¬ë˜ì–´ ì¤‘ê°„ ë‹¨ê³„ê°€ ì¢…ë£Œëœë‹¤.
- ëª¨ë“  ì •ë³´ê°€ í”Œë¡œìš°ë¡œ ì „ë‹¬ë˜ë¯€ë¡œ ê°’, ì˜ˆì™¸ ë° ë‹¤ë¥¸ íŠ¹ì • ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•  ìˆ˜ ìˆë‹¤.

## onEach

- í”Œë¡œìš°ì˜ ê°’ì„ í•˜ë‚˜ì”© ë°›ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤.
- ì¤‘ë‹¨ í•¨ìˆ˜ì´ë©°, ì›ì†ŒëŠ” ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ëœë‹¤.
- dealyë¥¼ ë„£ìœ¼ë©´ ê°ê°ì˜ ê°’ì´ íë¥¼ ë•Œë§ˆë‹¤ ì§€ì—°ë˜ê²Œ ëœë‹¤.

```kotlin
suspend fun main() {
	flowOf(1, 2, 3, 4) 
		.onEach { print(it) }
		.collect() // 1234
}
```

```kotlin
suspend fun main() {
	flowOf(1, 2)
		.onEach { delay(1000) }
		.collect { println(it) }
}
```

- ì¶œë ¥
    
    ```kotlin
    // (1ì´ˆ í›„)
    // 1
    // (1ì´ˆ í›„)
    // 2
    ```
    

## onStart

- ìµœì¢… ì—°ì‚°ì´ í˜¸ì¶œë  ë•Œì™€ ê°™ì´ í”Œë¡œìš°ê°€ ì‹œì‘ë˜ëŠ” ê²½ìš°ì— í˜¸ì¶œë˜ëŠ” ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•œë‹¤.
- ì²« ë²ˆì§¸ ì›ì†Œê°€ ìƒì„±ë˜ëŠ” ê±¸ ê¸°ë‹¤ë ¸ë‹¤ í˜¸ì¶œë˜ëŠ” ê²Œ ì•„ë‹ˆë¼ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤.
- ì²« ë²ˆì§¸ ì›ì†Œë¥¼ ìš”ì²­í–ˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜

```kotlin
suspend fun main() {
	flowOf(1, 2)
		.onEach { delay(1000) }
		.onStart { println("Before") }
		.collect { println(it) }
}
```

- ì¶œë ¥
    
    ```kotlin
    // Before
    // (1ì´ˆ í›„)
    // 1
    // (1ì´ˆ í›„)
    // 2
    ```
    

- onStartì—ì„œë„ ì›ì†Œë¥¼ ë‚´ë³´ë‚¼ ìˆ˜ ìˆë‹¤.
    - ì›ì†Œë“¤ì€ onStartë¶€í„° ì•„ë˜ë¡œ íë¥´ê²Œ ëœë‹¤.

```kotlin
suspend fun main() {
	flowOf(1, 2) 
		.onEach { delay(1000) }
		.onStart { emit(0) }
		.collect { println(it) }
}
```

- ì¶œë ¥
    
    ```kotlin
    // 0
    // (1ì´ˆ í›„)
    // 1
    // (1ì´ˆ í›„)
    // 2
    ```
    

## onCompletion

í”Œë¡œìš° ì™„ë£Œí•  ìˆ˜ ìˆëŠ” ë°©ë²•

- ì¡íˆì§€ ì•Šì€ ì˜ˆì™¸ ë°œìƒ
- ì½”ë£¨í‹´ì´ ì·¨ì†Œë˜ì—ˆì„ ë•Œ
- í”Œë¡œìš° ë¹Œë”ê°€ ëë‚¬ì„ ë•Œ(ì˜ˆë¥¼ ë“¤ë©´, ë§ˆì§€ë§‰ ì›ì†Œê°€ ì „ì†¡ë˜ì—ˆì„ ë•Œ)

onCompletion

- í”Œë¡œìš°ê°€ ì™„ë£Œë˜ì—ˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

```kotlin
suspend fun main() = coroutineScope {
	flowOf(1, 2)
		.onEach { delay(1000) }
		.onCompletion { println("Completed") }
		.collect { println(it) }
}
```

- ì¶œë ¥
    
    ```kotlin
    // (1ì´ˆ í›„)
    // 1
    // (1ì´ˆ í›„)
    // 2
    // Completed
    ```
    

```kotlin
suspend fun main() = coroutineScope {
	val job = launch {
		flowOf(1, 2) 
			.onEach { delay(1000) }
			.onCompletion { println("Completed") }
			.collect { println(it) }
	}
	delay(1100)
	job.cancel()
}
```

- ì¶œë ¥
    
    ```kotlin
    // (1ì´ˆ í›„)
    // 1
    // (0.1ì´ˆ í›„)
    // Completed
    ```
    

ì•ˆë“œë¡œì´ë“œì—ì„œëŠ” í”„ë¡œê·¸ë ˆìŠ¤ë°”ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ onStartë¥¼ ì‚¬ìš©í•˜ë©°, ê°€ë¦¬ê¸° ìœ„í•´ì„œëŠ” onCompletionì„ ì‚¬ìš©í•œë‹¤.

```kotlin
fun updateNews() {
	scope.launch {
		newsFlow()
			.onStart { showProgressbar() }
			.onCompletion { hideProgressbar() }
			.collect { view.showNews(it) }
  }
}
```

## onEmpty

í”Œë¡œìš°ëŠ” ì˜ˆê¸°ì¹˜ ì•Šì€ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ê°’ì„ ë‚´ë³´ë‚´ê¸° ì „ì— ì™„ë£Œë  ìˆ˜ ìˆë‹¤.

onEmpty

- ì›ì†Œë¥¼ ë‚´ë³´ë‚´ê¸° ì „ì— í”Œë¡œìš°ê°€ ì™„ë£Œë˜ë©´ ì‹¤í–‰ëœë‹¤.
- ê¸°ë³¸ê°’ì„ ë‚´ë³´ë‚´ê¸° ìœ„í•œ ëª©ì ìœ¼ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆë‹¤.

```kotlin
suspend fun main() = coroutineScope {
	flow<List<Int>> { delay(1000) }
		.onEmpty { emit(emptyList()) }
		.collect { println(it) }
}
```

- ì¶œë ¥
    
    ```kotlin
    // (1ì´ˆ í›„)
    // []
    ```
    

## catch

í”Œë¡œìš°ë¥¼ ë§Œë“¤ê±°ë‚˜ ì²˜ë¦¬í•˜ëŠ” ë„ì¤‘ì— ì˜ˆì™¸ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

â†’ ì´ëŸ¬í•œ ì˜ˆì™¸ëŠ” ì•„ë˜ë¡œ íë¥´ë©´ì„œ ì²˜ë¦¬í•˜ëŠ” ë‹¨ê³„ë¥¼ í•˜ë‚˜ì”© ë‹«ëŠ”ë‹¤.

catch

- ì˜ˆì™¸ë¥¼ ì¡ê³  ê´€ë¦¬í•œë‹¤.
- ë¦¬ìŠ¤ë„ˆëŠ” ì˜ˆì™¸ë¥¼ ì¸ìë¡œ ë°›ê³  ì •ë¦¬ë¥¼ ìœ„í•œ ì—°ì‚°ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.

```kotlin
class MyError : Throwable("My error")

val flow = flow {
	emit(1)
	emit(2)
	throw MyError() 
}

suspend fun main(): Unit {
	flow.onEach { println("Got $it") }
			.catch { println("Caught $it") }
			.collect { println("Collected $it") }
}
```

- ì¶œë ¥
    
    ```kotlin
    // Got 1
    // Collected 1
    // Got 2
    // Collected 2
    // Caught MyError: My Error
    ```
    

<aside>
ğŸ’¡ onEachëŠ” ì˜ˆì™¸ì— ë°˜ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤.
map, filterì™€ ê°™ì€ ë‹¤ë¥¸ í•¨ìˆ˜ì—ì„œë„ ë§ˆì°¬ê°€ì§€ë‹¤.
ì˜¤ì§ onCompletion í•¸ë“œëŸ¬ë§Œ ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ í˜¸ì¶œí•œë‹¤.

</aside>

- ì˜ˆì™¸ë¥¼ ì¡ì•„ ì „íŒŒë˜ëŠ” ê±¸ ë©ˆì¶˜ë‹¤.
- ìƒˆë¡œìš´ ê°’ì„ ì—¬ì „íˆ ë‚´ë³´ë‚¼ ìˆ˜ ìˆì–´ ë‚¨ì€ í”Œë¡œìš°ë¥¼ ì§€ì†í•  ìˆ˜ ìˆë‹¤.

```kotlin
val flow = flow {
	emit("Message1")
	throw MyError()
}

suspend fun main(): Unit {
	flow.catch { emit("Error") }
		  .collect { println("Collected $it") }
}
```

- ì¶œë ¥
    
    ```kotlin
    // Collected Message1
    // Collected Error
    ```
    

- catch í•¨ìˆ˜ì˜ ìœ—ë¶€ë¶„ì—ì„œ ë˜ì§„ ì˜ˆì™¸ì—ë§Œ ë°˜ì‘í•œë‹¤.(ì˜ˆì™¸ëŠ” ì•„ë˜ë¡œ íë¥¼ ë•Œ ì¡ëŠ”ë‹¤ê³  ìƒê°í•˜ë©´ ëœë‹¤)

![IMG_1D059EF33991-1](https://github.com/woowacourse-study/2023-BookOverFlow/assets/50761690/aa20aec7-9055-4308-a088-ef03a93f95f0)


ì•ˆë“œë¡œì´ë“œì—ì„œëŠ” í”Œë¡œìš°ì—ì„œ ì¼ì–´ë‚˜ëŠ” ì˜ˆì™¸ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ catchë¥¼ ì£¼ë¡œ ì‚¬ìš©í•œë‹¤.

```kotlin
fun updateNews() {
	scope.launch {
		newsFlow() 
			.catch { view.handleError(it) }
			.onStart { showProgressBar() }
			.onCompletion { hideProgressBar() }
			.collect { view.showNews(it) }
	}
}
```

ë¹ˆ ë¦¬ìŠ¤íŠ¸ì²˜ëŸ¼ ìŠ¤í¬ë¦°ì—ì„œ ë³´ì—¬ì§€ëŠ” ê¸°ë³¸ê°’ì„ ë‚´ë³´ë‚´ê¸° ìœ„í•´ catchë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆë‹¤.

```kotlin
fun updateNews() {
	scope.launch {
		newsFlow()
			.catch {
				view.handleError(it)
				emit(emptyList())
			}
			.onStart { showProgressBar() }
			.onCompletion { hideProgressBar() }
			.collect { view.showNews(it) }
 }
}
```

## ì¡íˆì§€ ì•Šì€ ì˜ˆì™¸

í”Œë¡œìš°ì—ì„œ ì¡íˆì§€ ì•Šì€ ì˜ˆì™¸ëŠ” í”Œë¡œìš°ë¥¼ ì¦‰ì‹œ ì·¨ì†Œí•˜ë©°, collectëŠ” ì˜ˆì™¸ë¥¼ ë‹¤ì‹œ ë˜ì§„ë‹¤.

ì¤‘ë‹¨ í•¨ìˆ˜ê°€ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ê³¼ ê°™ìœ¼ë©°, coroutineScope ë˜í•œ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•œë‹¤.

í”Œë¡œìš° ë°”ê¹¥ì—ì„œ ì „í†µì ì¸ try-catch ë¸”ë¡ì„ ì‚¬ìš©í•´ì„œ ì˜ˆì™¸ë¥¼ ì¡ì„ ìˆ˜ë„ ìˆë‹¤.

```kotlin
val flow = flow {
	emit("Message1")
	throw MyError()
}

suspend fun main(): Unit {
	try {
		flow.collect { println("Collected $it") }
	} catch (e: MyError) {
		println("Caught")
	}
}
```

- ì¶œë ¥
    
    ```kotlin
    // Collected Message1
    // Caught
    ```
    

catchë¥¼ ì‚¬ìš©í•˜ëŠ” ê±´ ìµœì¢… ì—°ì‚°ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ”ë° ë„ì›€ì´ ë˜ì§€ ì•ŠëŠ”ë‹¤.

â†’ collectì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ì˜ˆì™¸ë¥¼ ì¡ì§€ ëª»í•˜ê²Œ ë˜ì–´ ë¸”ë¡ ë°–ìœ¼ë¡œ ì˜ˆì™¸ê°€ ì „ë‹¬ëœë‹¤.

```kotlin
val flow = flow {
	emit("Message1")
	emit("Message2")
}

suspend fun main(): Unit {
	flow.onStart { println("Before") }
			.catch { println("Caught $it") }
			.collect { throw MyError() }
			
}
```

- ì¶œë ¥
    
    ```kotlin
    // Before
    // Exception in thread "..." MyError: My error
    ```
    

collectì˜ ì—°ì‚°ì„ onEachë¡œ ì˜®ê¸°ê³  catch ì´ì „ì— ë‘ëŠ” ë°©ë²•ì´ ìì£¼ ì‚¬ìš©ëœë‹¤.

â†’ collectì˜ ì—°ì‚°ì„ ì˜®ê¸´ë‹¤ë©´ catchê°€ ëª¨ë“  ì˜ˆì™¸ë¥¼ ì¡ì„ ìˆ˜ ìˆë‹¤.

```kotlin
val flow = flow {
	emit("Message1")
	emit("Message2")
}

suspend fun main(): Unit {
	flow.onStart { println("Before") }
			.onEach { throw MyError() }
			.catch { println("Caught $it") }
			.collect()
}
```

- ì¶œë ¥
    
    ```kotlin
    // Before
    // Caught MyError: My error
    ```
    

## flowOn

(onEach, onStart, onCompletionê³¼ ê°™ì€) í”Œë¡œìš° ì—°ì‚°ê³¼ (flowë‚˜ channelFlowì™€ ê°™ì€) í”Œë¡œìš° ë¹Œë”ì˜ ì¸ìë¡œ ì‚¬ìš©ë˜ëŠ” ëŒë‹¤ì‹ì€ ëª¨ë‘ ì¤‘ë‹¨ í•¨ìˆ˜ì´ë‹¤. 

ì¤‘ë‹¨í•¨ìˆ˜ëŠ” ì»¨í…ìŠ¤íŠ¸ê°€ í•„ìš”í•˜ë©°(êµ¬ì¡°í™”ëœ ë™ì‹œì„±ì„ ìœ„í•´) ë¶€ëª¨ì™€ ê´€ê³„ë¥¼ ìœ ì§€í•œë‹¤.

í”Œë¡œìš°ì˜ í•¨ìˆ˜ë“¤ì˜ ì»¨í…ìŠ¤íŠ¸ â†’ collectê°€ í˜¸ì¶œë˜ëŠ” ê³³ì˜ ì»¨í…ìŠ¤íŠ¸ì´ë‹¤.

```kotlin
fun usersFlow(): Flow<String> = flow {
	repeat(2) {
		val ctx = currentCoroutineContext()
		val name = ctx[coroutineName]?.name
		emit("User$it in $name")
	}
}

suspend fun main() {
	val users = usersFlow()
	withContext(CoroutineName("Name1")) {
		users.collect { println(it) }
  }
  withContext(CoroutineName("Name2")) {
	  users.collect { printn(it) }
	}
}
```

- ì¶œë ¥
    
    ```kotlin
    // User0 in Name1
    // User1 in Name1
    // User0 in Name2
    // User1 in Name2
    ```
    

â†’ ìµœì¢… ì—°ì‚°ì„ í˜¸ì¶œí•˜ë©´ ìƒìœ„ì— ìˆëŠ” ëª¨ë“  ì›ì†Œë¥¼ ìš”ì²­í•˜ë©´ì„œ ì½”ë£¨í‹´ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì „ë‹¬í•œë‹¤.

**flowOn**

- ì»¨í…ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•  ìˆ˜ë„ ìˆë‹¤.
- í”Œë¡œìš°ì—ì„œ ìœ—ë¶€ë¶„ì— ìˆëŠ” í•¨ìˆ˜ì—ì„œë§Œ ì‘ë™í•˜ëŠ” ê±¸ ê¸°ì–µí•´ì•¼ í•œë‹¤.
    
![IMG_D4BBAB6B4C09-1](https://github.com/woowacourse-study/2023-BookOverFlow/assets/50761690/0216a6c1-9319-493a-a3d2-2ef38c98f2cf)

    

```kotlin
suspend fun present(place: String, message: String) {
	val ctx = coroutineContext
	val name = ctx[CoroutineName]?.name
	println("[$name] $message on $place")
}

fun messagesFlow(): Flow<String> = flow {
	present("flow builder", "Message")
	emit("Message")
}

suspend fun main() {
	val users = messagesFlow()
	withContext(CoroutineName("Name1")) {
		users
			.flowOn(CoroutineName("Name3"))
			.onEach { present("onEach", it) }
			.flowOn(CoroutineName("Name2"))
			.collect { present("collect", it) }
	}
}
```

- ì¶œë ¥
    
    ```kotlin
    // [Name3] Message on flow builder
    // [Name2] Message on onEach
    // [Name1] Message on collet
    ```
    

## launchIn

collectëŠ” í”Œë¡œìš°ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ì½”ë£¨í‹´ì„ ì¤‘ë‹¨í•˜ëŠ” ì¤‘ë‹¨ ì—°ì‚°

launch ë¹Œë”ë¡œ collectë¥¼ ë˜í•‘í•˜ë©´ í”Œë¡œìš°ë¥¼ ë‹¤ë¥¸ ì½”ë£¨í‹´ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

**launchIn**

- ìœ ì¼í•œ ì¸ìë¡œ ìŠ¤ì½”í”„ë¥¼ ë°›ì•„ collectë¥¼ ìƒˆë¡œìš´ ì½”ë£¨í‹´ì—ì„œ ì‹œì‘í•  ìˆ˜ ìˆë‹¤.
- ë³„ë„ì˜ ì½”ë£¨í‹´ì—ì„œ í”Œë¡œìš°ë¥¼ ì‹œì‘í•˜ê¸° ìœ„í•´ ì£¼ë¡œ ì‚¬ìš©í•œë‹¤.

```kotlin
fun <T> Flow<T>.launchIn(scope: CoroutineScope): Job = 
	scope.launch { collect() }
```

```kotlin
suspend fun main(): Unit = coroutineScope {
	flowOf("User1", "User2")
		.onStart { println("Users:") }
		.onEach { println(it) }
		.launchInt(this)
}
```

- ì¶œë ¥
    
    ```kotlin
    // Users:
    // User1
    // User2
    ```
    

### ìš”ì•½

í”Œë¡œìš°ê°€ ì‹œì‘ë  ë•Œ, ë‹«í ë•Œ, ë˜ëŠ” ê° ì›ì†Œë¥¼ íƒìƒ‰í•  ë•Œ í”Œë¡œìš°ì— ì‘ì—…ì„ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.
