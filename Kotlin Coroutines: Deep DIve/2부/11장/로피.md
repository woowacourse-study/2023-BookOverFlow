# 11ì¥ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜

## ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ê°€ ì†Œê°œë˜ê¸° ì „ì— ì‚¬ìš©í•œ ë°©ë²•ë“¤

### **ì¤‘ë‹¨ í•¨ìˆ˜ì—ì„œ ì¤‘ë‹¨ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒ**

- ì‘ì—…ì´ ë™ì‹œì— ì§„í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.

```kotlin
// ë°ì´í„°ë¥¼ ë™ì‹œì— ê°€ì ¸ì˜¤ì§€ ì•Šê³ , ìˆœì°¨ì ìœ¼ë¡œ ê°€ì ¸ì˜¨ë‹¤.
suspend fun getUserProfile(): UserProfileData {
	val user = getUserData() // (1ì´ˆ í›„)
	val notifications = getNotifications() // (1ì´ˆ í›„)
	
	return UserProfileData(
		user = user,
		notifications = notifications,
	)
}
```

 

ë‘ ê°œì˜ ì¤‘ë‹¨ í•¨ìˆ˜ë¥¼ ë™ì‹œì— ì‹¤í–‰í•˜ë ¤ë©´ ê°ê° asyncë¡œ ë˜í•‘í•´ì•¼ í•œë‹¤.

í•˜ì§€ë§Œ ìŠ¤ì½”í”„ë¥¼ í•„ìš”ë¡œ í•œë‹¤ â†’ GlobalScopeë¥¼ ì‚¬ìš©í•˜ëŠ” ê±´ ì¢‹ì€ ë°©ë²•ì´ ì•„ë‹ˆë‹¤.

```kotlin
// GlobalScopeëŠ” ê·¸ì € EmptyCoroutineContextë¥¼ ê°€ì§„ ìŠ¤ì½”í”„
public object GlobalScope : CoroutineScope {
	override val coroutineContext: CoroutineContext
		get() = EmptyCoroutineContext
}
```

**GlobalScopeì—ì„œ asyncë¥¼ í˜¸ì¶œí•˜ë©´ ë¶€ëª¨ ì½”ë£¨í‹´ê³¼ ì•„ë¬´ëŸ° ê´€ê³„ê°€ ì—†ë‹¤.**

- async ì½”ë£¨í‹´ì€ ì·¨ì†Œë  ìˆ˜ ì—†ë‹¤.(ë¶€ëª¨ê°€ ì·¨ì†Œë˜ì–´ë„ async ë‚´ë¶€ì˜ í•¨ìˆ˜ê°€ ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœê°€ ë˜ë¯€ë¡œ ì‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ìì›ì´ ë‚­ë¹„ëœë‹¤.)
- ë¶€ëª¨ë¡œë¶€í„° ìŠ¤ì½”í”„ë¥¼ ìƒì†ë°›ì§€ ì•ŠëŠ”ë‹¤.(í•­ìƒ ê¸°ë³¸ ë””ìŠ¤íŒ¨ì²˜ì—ì„œ ì‹¤í–‰ë˜ë©°, ë¶€ëª¨ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì „í˜€ ì‹ ê²½ ì“°ì§€ ì•ŠëŠ”ë‹¤.)

**ê²°ê³¼**

â†’ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©° ì“¸ë°ì—†ì´ CPUë¥¼ ë‚­ë¹„í•œë‹¤.

â†’ ì½”ë£¨í‹´ì„ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë„êµ¬ê°€ ì‘ë™í•˜ì§€ ì•Šì•„ í•¨ìˆ˜ë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ì•„ì£¼ ì–´ë µë‹¤.

### ìŠ¤ì½”í”„ë¥¼ ì¸ìë¡œ ë„˜ê¸´ë‹¤

```kotlin
// ì´ë ‡ê²Œ êµ¬í˜„í•˜ë©´ ì•ˆëœë‹¤.
suspend fun getUserProfile(
	scope: CoroutineScope
): UserProfileData {
	val user = scope.async { getUserData() }
	val notifications = scope.async { getNotifications() }
	
	return UserProfileData(
		user = user.await(), // (1ì´ˆ í›„)
		notifications = notifications.await(),
	)
}

// or

// ì´ë ‡ê²Œ êµ¬í˜„í•˜ë©´ ì•ˆëœë‹¤.
suspend fun CoroutineScope.getUserProfile(): UserProfileData {
	val user = async { getUserData() }
	val notifications = async { getNotifications() }
	
	return UserProfileData(
		user = user.await(), // (1ì´ˆ í›„)
		notifications = notifications.await(),
	)
}
```

ì´ ë°©ë²•ì€ `ì·¨ì†Œê°€ ê°€ëŠ¥í•˜ë©° ì ì ˆí•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤ëŠ” ì `ì—ì„œ ì¢€ ë” ë‚˜ì€ ë°©ì‹ì´ë¼ê³  í•  ìˆ˜ ìˆë‹¤.

But, ìŠ¤ì½”í”„ê°€ í•¨ìˆ˜ì—ì„œ í•¨ìˆ˜ë¡œ ì „ë‹¬ë˜ì–´ì•¼ í•œë‹¤ëŠ” ê²ƒì´ë‹¤.

â†’ ìŠ¤ì½”í”„ë¼ í•¨ìˆ˜ë¡œ ì „ë‹¬ë˜ë©´ ìŠ¤ì½”í”„ì—ì„œ ì˜ˆìƒí•˜ì§€ ëª»í•œ ë¶€ì‘ìš©ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

ex) asyncì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ëª¨ë“  ìŠ¤ì½”í”„ê°€ ë‹«íˆê²Œ ëœë‹¤(Job ì‚¬ìš©)

ìŠ¤ì½”í”„ì— ì ‘ê·¼í•˜ëŠ” í•¨ìˆ˜ê°€ cancel ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ ìŠ¤ì½”í”„ë¥¼ ì·¨ì†Œí•˜ëŠ” ë“± ìŠ¤ì½”í”„ ì¡°ì‘í•  ìˆ˜ ìˆë‹¤.

```kotlin
data class Details(val name: String, val followers: Int)
data class Tweet(val text: String)

fun getFollowersNumber(): Int =
    throw Error("Service exception")

suspend fun getUserName(): String {
    delay(500)
    return "marcinmoskala"
}

suspend fun getTweets(): List<Tweet> {
    return listOf(Tweet("Hello, world"))
}

suspend fun CoroutineScope.getUserDetails(): Details {
    val userName = async { getUserName() }
    val followersNumber = async { getFollowersNumber() }
    return Details(userName.await(), followersNumber.await())
}

fun main() = runBlocking {
    val details = try {
        getUserDetails()
    } catch (e: Error) {
        null   
    }

    val tweets = async { getTweets() }
    println("User: $details")
    println("Tweets: ${tweets.await()}")
}
```

- ì¶œë ¥
    
    ì˜ˆì™¸ë§Œ ë°œìƒí•œë‹¤.
    

â†’ getFollowersNumberì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ê°€ asyncë¥¼ ì¢…ë£Œì‹œí‚¤ê³ , ì „ì²´ ìŠ¤ì½”í”„ê°€ ì¢…ë£Œë˜ëŠ” ê±¸ë¡œ ì´ì–´ì ¸ í”„ë¡œê·¸ë¨ì´ ëë‚˜ë²„ë¦°ë‹¤.

## coroutineScope

**ìŠ¤ì½”í”„ë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘ë‹¨í•¨ìˆ˜, ì¸ìë¡œ ë“¤ì–´ì˜¨ í•¨ìˆ˜ê°€ ìƒì„±í•œ ê°’ì„ ë°˜í™˜í•œë‹¤.** 

```kotlin
// ë¦¬ì‹œë²„ ì—†ì´ ê³§ë°”ë¡œ í˜¸ì¶œëœë‹¤.
suspend fun <R> coroutineScope(
	block: suspend CoroutineScope.() -> R
): R
```

ìƒˆë¡œìš´ ì½”ë£¨í‹´ì„ ìƒì„±í•˜ì§€ë§Œ ìƒˆë¡œìš´ ì½”ë£¨í‹´ì´ ëë‚  ë•Œê¹Œì§€ coroutineScopeë¥¼ í˜¸ì¶œí•œ ì½”ë£¨í‹´ì„ ì¤‘ë‹¨í•˜ê¸° ë•Œë¬¸ì— í˜¸ì¶œí•œ ì½”ë£¨í‹´ì´ ì‘ì—…ì„ ë™ì‹œì— ì‹œì‘í•˜ì§€ ì•ŠëŠ”ë‹¤.

```kotlin
fun main() = runBlocking {
	val a = coroutineScope {
		delay(1000)
		10
	}
	println("a is calculated")
	val b = coroutineScope {
		delay(1000)
		20
	}
	println(a) // 10
	println(b) // 20
}
```

- ì¶œë ¥
    
    1ì´ˆ í›„
    
    a is calculated
    
    1ì´ˆ í›„
    
    10
    
    20
    

ìƒì„±ëœ ìŠ¤ì½”í”„ëŠ” ë°”ê¹¥ì˜ ìŠ¤ì½”í”„ì—ì„œ coroutineContextë¥¼ ìƒì†ë°›ì§€ë§Œ ì»¨í…ìŠ¤íŠ¸ì˜ Jobì„ ì˜¤ë²„ë¼ì´ë”©í•œë‹¤.

â†’ ìƒì„±ëœ ìŠ¤ì½”í”„ëŠ” ë¶€ëª¨ê°€ í•´ì•¼ í•  ì±…ì„ì„ ì´ì–´ë°›ëŠ”ë‹¤.

- ë¶€ëª¨ë¡œë¶€í„° ì»¨í…ìŠ¤íŠ¸ë¥¼ ìƒì†ë°›ëŠ”ë‹¤.
- ìì‹ ì˜ ì‘ì—…ì„ ëë‚´ê¸° ì „ê¹Œì§€ ëª¨ë“  ìì‹ì„ ê¸°ë‹¤ë¦°ë‹¤.
- ë¶€ëª¨ê°€ ì·¨ì†Œë˜ë©´ ìì‹ë“¤ ëª¨ë‘ë¥¼ ì·¨ì†Œí•œë‹¤.

```kotlin
suspend fun longTask() = coroutineScope {
	launch {
		delay(1000)
		val name = coroutineContext[CoroutineName]?.name
		println("[$name] Finished task 1")
	}
	launch {
		delay(2000)
		val name = coroutineContext[CoroutineName]?.name
		println("[$name] Finished task 2")
	}
}

fun main() = runBlocking(CoroutineName("Parent")) {
	println("Before")
	longTask()
	println("After")
}
```

- ì¶œë ¥
    
    Before
    
    1ì´ˆ í›„
    
    [Parent] Finished task 1
    
    1ì´ˆ í›„
    
    [Parent] Finished task 2
    
    After
    

ë¶€ëª¨ê°€ ì·¨ì†Œë˜ë©´ ì•„ì§ ëë‚˜ì§€ ì•Šì€ ìì‹ ì½”ë£¨í‹´ì´ ì „ë¶€ ì·¨ì†Œëœë‹¤.

```kotlin
suspend fun longTask() = coroutineScope {
	launch {
		delay(1000)
		val name = coroutineContext[CoroutineName]?.name
		println("[$name] Finished Task 1")
	}
	launch {
		delay(2000)
		val name = coroutineContext[CoroutineName]?.name
		println("[$name] Finished Task 2")
	}
}

fun main(): Unit = runBlocking {
	val job = launch(CoroutineName("Parent")) {
		longTask()
	}
	delay(1500)
	job.cancel()
}
```

- ì¶œë ¥
    
    [Parent] Finished task 1
    

`coroutineScopeë‚˜ ìŠ¤ì½”í”„ì— ì†í•œ ìì‹ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ë‹¤ë¥¸ ëª¨ë“  ìì‹ì´ ì·¨ì†Œë˜ê³  ì˜ˆì™¸ê°€ ë‹¤ì‹œ ë˜ì ¸ì§„ë‹¤.`

```kotlin
data class Details(val name: String, val followers: Int)
data class Tweet(val text: String)
class ApiException(
	val code: Int,
	message: String,
) : Throwable(message)

fun getFollowersNumber(): Int =
    throw ApiException(500, "Service unavailable")

suspend fun getUserName(): String {
    delay(500)
    return "marcinmoskala"
}

suspend fun getTweets(): List<Tweet> {
    return listOf(Tweet("Hello, world"))
}

suspend fun getUserDetails(): Details = coroutineScope {
    val userName = async { getUserName() }
    val followersNumber = async { getFollowersNumber() }
    return Details(userName.await(), followersNumber.await())
}

fun main() = runBlocking {
    val details = try {
        getUserDetails()
    } catch (e: Error) {
        null   
    }

    val tweets = async { getTweets() }
    println("User: $details")
    println("Tweets: ${tweets.await()}")
}
```

- ì¶œë ¥
    
    User: null
    
    Tweets: [Tweet(text=Hello, world)]
    

ì¤‘ë‹¨ í•¨ìˆ˜ì—ì„œ ë³‘ë ¬ë¡œ ì‘ì—…ì„ ìˆ˜í–‰í•  ê²½ìš° coroutineScopeë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

```kotlin
suspend fun getUserProfile(): UserProfileData = 
	coroutineScope {
		val user = async { getUserData() }
		val notifications = async { getNotifications() }
		
		UserProfileData(
			user = user.await(),
			notifications = notifications.await(),
		)
	}
```

coroutineScopeëŠ” ì¤‘ë‹¨ ë©”ì¸ í•¨ìˆ˜ ë³¸ì²´ë¥¼ ë˜í•‘í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©ëœë‹¤.

```kotlin
suspend fun main(): Unit = coroutineScope {
	launch {
		delay(1000)
		println("World")
	}
	println("Hello, ")
}
```

- ì¶œë ¥
    
    Hello, 
    
    1ì´ˆ í›„
    
    World
    

coroutineScope í•¨ìˆ˜ëŠ” ê¸°ì¡´ì˜ ì¤‘ë‹¨ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë²—ì–´ë‚œ ìƒˆë¡œìš´ ìŠ¤ì½”í”„ë¥¼ ë§Œë“ ë‹¤.

**ë¶€ëª¨ë¡œë¶€í„° ìŠ¤ì½”í”„ë¥¼ ìƒì†ë°›ê³  êµ¬ì¡°í™”ëœ ë™ì‹œì„±ì„ ì§€ì›í•œë‹¤.**

## ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜

**supervisorScope**

- coroutineScopeì™€ ë¹„ìŠ·í•˜ì§€ë§Œ, Job ëŒ€ì‹  SupervisorJob ì‚¬ìš©

**withContext** 

- ì½”ë£¨í‹´ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë°”ê¿€ ìˆ˜ ìˆëŠ” coroutineScopeì´ë‹¤.

**withTimeout**

- íƒ€ì„ì•„ì›ƒì´ ìˆëŠ” coroutineScopeì´ë‹¤.

<aside>
â— ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ëŠ” ì¤‘ë‹¨ í•¨ìˆ˜ì—ì„œ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ ì‚¬ìš©ëœë‹¤.

</aside>

**ì½”ë£¨í‹´ ë¹Œë”ì™€ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜**

![IMG_5D2A742426C6-1](https://github.com/woowacourse-study/2023-BookOverFlow/assets/50761690/a1070185-2f9b-4bb7-9d3a-5dedc6098d1b)


**runBlocking**

- ì½”ë£¨í‹´ ë¹Œë”ë³´ë‹¤ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ì™€ ë¹„ìŠ·í•œ ì ì´ ë§ë‹¤
- í•¨ìˆ˜ ë³¸ì²´ë¥¼ ê³§ë°”ë¡œ í˜¸ì¶œí•˜ê³  ê·¸ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤

**runBlockingê³¼ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ì˜ ì°¨ì´ì **

- runBlockingì€ ë¸”ë¡œí‚¹ í•¨ìˆ˜ì§€ë§Œ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ëŠ” ì¤‘ë‹¨ í•¨ìˆ˜ì´ë‹¤.
- runBlockingì€ ì½”ë£¨í‹´ì˜ ê³„ì¸µì—ì„œ ê°€ì¥ ìƒìœ„ì— ìˆìœ¼ë©°, ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ëŠ” ê³„ì¸µ ì¤‘ê°„ì— ìˆë‹¤.

### withContext

**coroutineContextì™€ ë¹„ìŠ·í•˜ì§€ë§Œ ìŠ¤ì½”í”„ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.**

withContextì˜ ì¸ìë¡œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•˜ë©´ ë¶€ëª¨ ìŠ¤ì½”í”„ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ëŒ€ì²´í•œë‹¤.

â†’ withContext(EmptyCoroutineContext) ì™€ coroutineScope()ëŠ” ê°™ì€ ë°©ì‹ìœ¼ë¡œ ë™ì‘í•œë‹¤.

```kotlin
fun CoroutineScope.log(text: String) {
	val name = this.coroutineContext[coroutineName]?.name
	println("[$name] $text")
}

fun main() = runBlocking(CoroutineName("Parent")) {
	log("Before")
	
	withContext(CoroutineName("Child 1")) {
		delay(1000)
		log("Hello 1")
	}
	
	withContext(CoroutineName("Child 2")) {
		delay(1000)
		log("Hello 2")
	}
	
	log("After")
}
```

- ì¶œë ¥
    
    [Parent] Before
    
    1ì´ˆ í›„
    
    [Child 1] Hello 1
    
    1ì´ˆ í›„
    
    [Child 2] Hello 2
    
    [Parent] After
    

withContext í•¨ìˆ˜ëŠ” ê¸°ì¡´ ìŠ¤ì½”í”„ì™€ ì»¨í…ìŠ¤íŠ¸ê°€ ë‹¤ë¥¸ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ë¥¼ ì„¤ì •í•˜ê¸° ìœ„í•´ ì£¼ë¡œ ì‚¬ìš©ëœë‹¤.

```kotlin
launch(Dispatchers.Main) {
	view.showProgressBar()
	withContext(Dispatchers.IO) {
		fileRepository.saveData(data)
	}
	view.hideProgressBar()
}
```

> coroutineScope {} ê³¼ async {}.await() ì‘ë™ë°©ì‹ ë¹„ìŠ·í•˜ë‹¤.
withContext(context) ê³¼ async(context) {}.await() ì‘ë™ë°©ì‹ ë¹„ìŠ·í•˜ë‹¤.

asyncëŠ” ìŠ¤ì½”í”„ë¥¼ í•„ìš”ë¡œ í•˜ì§€ë§Œ, coroutineScopeì™€ withContextëŠ” í•´ë‹¹ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œ ì¤‘ë‹¨ì ì—ì„œ ìŠ¤ì½”í”„ë¥¼ ë“¤ê³ ì˜¨ë‹¤.
â†’ coroutineScopeì™€ withContextë¥¼ ì‚¬ìš©í•˜ëŠ” í¸ì´ ì¢‹ë‹¤!
> 

### supervisorScope

í˜¸ì¶œí•œ ìŠ¤ì½”í”„ë¡œë¶€í„° ìƒì†ë°›ì€ CoroutineScopeë¥¼ ë§Œë“¤ê³  ì§€ì •ëœ ì¤‘ë‹¨ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤.

SupervisorJobìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë”©í•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ìì‹ ì½”ë£¨í‹´ì´ ì˜ˆì™¸ë¥¼ ë˜ì§€ë”ë¼ë„ ì·¨ì†Œë˜ì§€ ì•ŠëŠ”ë‹¤.

```kotlin
fun main() = runBlocking {
	println("Before")
	
	supervisorScope {
		launch {
			delay(1000)
			throw Error()
		}
		
		launch {
			delay(2000)
			println("Done")
		}
	}
	
	println("After")
}
```

- ì¶œë ¥
    
    Before
    
    1ì´ˆ í›„
    
    ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤
    
    1ì´ˆ í›„
    
    Done
    
    After
    

supervisorScopeì€ ì„œë¡œ ë…ë¦½ì ì¸ ì‘ì—…ì„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜ì—ì„œ ì£¼ë¡œ ì‚¬ìš©ëœë‹¤.

```kotlin
suspend fun notifyAnalytics(actions: List<UserAction>) =
	supervisorScope {
		actions.forEach { action ->
			launch {
				notifyAnalytics(action)
			}
		}
	}
```

asyncë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ì˜ˆì™¸ê°€ ë¶€ëª¨ë¡œ ì „íŒŒë˜ëŠ”ê±¸ ë§‰ëŠ” ê²ƒ ì™¸ì— ì¶”ê°€ì ì¸ ì˜ˆì™¸ ì²˜ë¦¬ê°€ í•„ìš”í•˜ë‹¤.

â†’ awaitë¥¼ í˜¸ì¶œí•˜ê³  async ì½”ë£¨í‹´ì´ ì˜ˆì™¸ë¡œ ëë‚˜ê²Œ ëœë‹¤ë©´ awaitëŠ” ì˜ˆì™¸ë¥¼ ë‹¤ì‹œ ë˜ì§„ë‹¤.

â†’ asyncì—ì„œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ë¥¼ ì „ë¶€ ì²˜ë¦¬í•˜ë ¤ë©´ try-catch ë¸”ë¡ìœ¼ë¡œ await í˜¸ì¶œì„ ë˜í•‘í•´ì•¼ í•œë‹¤.

```kotlin
class ArticlesRepositoryComposite(
	private val articleRepositories: List<ArticleRepository>,
) : ArticleRepository {
	override suspend fun fetchArticles(): List<Article> = 
		supervisorScope {
			articleRepositories
				.map { async { it.fetchArticles() } }
				.mapNotNull {
					try {
						it.await()
					} catch (e: Throwable) {
						e.printStackTrace()
						null
					}
				}
				.flatten()
				.sortedByDescending { it.publishedAt }
		}
}
		
```

<aside>
ğŸš« supervisorScope ëŒ€ì‹  withContext(SupervisorJob())ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.

</aside>

withContext(SupervisorJob())ì„ ì‚¬ìš©í•˜ë©´ withContextëŠ” ì—¬ì „íˆ ê¸°ì¡´ì— ê°€ì§€ê³  ìˆë˜ Jobì„ ì‚¬ìš©í•˜ë©° SupervisorJob()ì´ í•´ë‹¹ ì¡ì˜ ë¶€ëª¨ê°€ ëœë‹¤.

â†’ í•˜ë‚˜ì˜ ìì‹ ì½”ë£¨í‹´ì´ ì˜ˆì™¸ë¥¼ ë˜ì§„ë‹¤ë©´ ë‹¤ë¥¸ ìì‹ë“¤ ë˜í•œ ì·¨ì†Œê°€ ëœë‹¤.

â†’ withContext ë˜í•œ ì˜ˆì™¸ë¥¼ ë˜ì§€ê¸° ë•Œë¬¸ì— SupervisorJob()ì€ ì‚¬ì‹¤ìƒ ì“¸ëª¨ê°€ ì—†ê²Œ ëœë‹¤.

```kotlin
fun main() = runBlocking {
	println("Before")
	
	withContext(SupervisorJob()) {
		launch {
			delay(1000)
			throw Error()
		}
		
		launch {
			delay(2000)
			println("Done")
		}
	}
	
	println("After")
}
```

- ì¶œì²˜
    
    Before
    
    1ì´ˆ í›„
    
    Exception
    

### withTimeout

ìŠ¤ì½”í”„ë¥¼ ë§Œë“¤ê³  ê°’ì„ ë°˜í™˜í•œë‹¤. 

withTimeoutì— ì•„ì£¼ í° íƒ€ì„ì•„ì›ƒ ê°’ì„ ë„£ìœ¼ë©´ coroutineScopeì™€ ë‹¤ë¥¼ ê²ƒì´ ì—†ë‹¤.

**ì¸ìë¡œ ë“¤ì–´ì˜¨ ëŒë‹¤ì‹ì„ ì‹¤í–‰í•  ë•Œ ì‹œê°„ ì œí•œì´ ìˆë‹¤.**

ì‹¤í–‰í•˜ëŠ”ë° ì‹œê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¬ë©´ ëŒë‹¤ì‹ì„ ì·¨ì†Œë˜ê³  **TimeoutCancellationExceptionì„ ë˜ì§„ë‹¤**.(CancellationException ì„œë¸Œ íƒ€ì…)

```kotlin
suspend fun test(): Int = withTimeout(1500) {
	delay(1000)
	println("Still thinking")
	delay(1000)
	println("Done!")
	42
}

suspend fun main(): Unit = coroutineScope {
	try {
		test()
	} catch (e: TimeoutCancellationException) {
		println("Cancelled")
	}
	delay(1000) // test í•¨ìˆ˜ê°€ ì·¨ì†Œë˜ì—ˆê¸° ë•Œë¬¸ì—,
	// íƒ€ì„ì•„ì›ƒ ì‹œê°„ì„ ëŠ˜ë ¤ë„ ì•„ë¬´ëŸ° ë„ì›€ì´ ë˜ì§€ ì•ŠëŠ”ë‹¤.
}
```

withTimeout í•¨ìˆ˜ëŠ” **í…ŒìŠ¤íŠ¸í•  ë•Œ íŠ¹íˆ ìœ ìš©**í•˜ë‹¤.

íŠ¹ì • í•¨ìˆ˜ê°€ ì‹œê°„ì´ ë§ê²Œ í˜¹ì€ ì ê²Œ ê±¸ë¦¬ëŠ”ì§€ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œ ì‚¬ìš©ëœë‹¤.

runTest ë‚´ë¶€ì—ì„œ ì‚¬ìš©ëœë‹¤ë©´ withTimeoutì€ ê°€ìƒì‹œê°„ìœ¼ë¡œ ì‘ë™í•˜ê²Œ ëœë‹¤.

```kotlin
class Test {
	@Test
	fun testTime2() = runTest {
		withTimeout(1000) {
			// 1000msë³´ë‹¤ ì ê²Œ ê±¸ë¦¬ëŠ” ì‘ì—…
			delay(900)
		}
	}
	
	@Test(expected = TimeoutCancellationException::class)
	fun testTime1() = runTest {
		withTimeout(1000) {
			// 1000msë³´ë‹¤ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì‘ì—…
			delay(1100)
		}
	}
	
	@Test
	fun testTime3() = runBlocking {
		withTimeout(1000) {
			// ê·¸ë‹¤ì§€ ì˜¤ë˜ ê±¸ë¦¬ì§€ ì•ŠëŠ” ì¼ë°˜ì ì¸ í…ŒìŠ¤íŠ¸
			delay(900) // ì‹¤ì œë¡œ 900msë§Œí¼ ê¸°ë‹¤ë¦°ë‹¤.
		}
	}
```

ì½”ë£¨í‹´ ë¹Œë” ë‚´ë¶€ì—ì„œ TimeoutCancellationExceptionì„ ë˜ì§€ë©´ í•´ë‹¹ ì½”ë£¨í‹´ë§Œ ì·¨ì†Œê°€ ë˜ê³  ë¶€ëª¨ì—ê²ŒëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤.

```kotlin
suspend fun main(): Unit = coroutineScope {
	launch { // 1
		launch { // 2, ë¶€ëª¨ì— ì˜í•´ ì·¨ì†Œëœë‹¤.
		 delay(2000)
		 println("Will not be printed")
		}
		withTimeout(1000) { // ì´ ì½”ë£¨í‹´ì´ launchë¥¼ ì·¨ì†Œí•œë‹¤.
			delay(1500)
		}
	}
	launch { // 3
		delay(2000)
		println("Done")
	}
}
```

- ì¶œë ¥
    
    2ì´ˆ í›„
    
    Done
    

**withTimeoutOrNull**

- ì˜ˆì™¸ë¥¼ ë˜ì§€ì§€ ì•ŠëŠ”ë‹¤.
- íƒ€ì„ì•„ì›ƒì„ ì´ˆê³¼í•˜ë©´ ëŒë‹¤ì‹ì´ ì·¨ì†Œë˜ê³  nullì´ ë°˜í™˜ëœë‹¤.
- ë˜í•‘ í•¨ìˆ˜ì—ì„œ ê±¸ë¦¬ëŠ” ì‹œê°„ì´ ë„ˆë¬´ ê¸¸ ë•Œ ë¬´ì–¸ê°€ ì˜ëª»ë˜ì—ˆìŒì„ ì•Œë¦¬ëŠ” ìš©ë„ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆë‹¤.

```kotlin
suspend fun fetchUser(): User {
	// ì˜ì›íˆ ì‹¤í–‰ëœë‹¤.
	while(true) {
		yield()
	}
}

suspend funn getUserOrNull(): User? = 
	withTimeoutOrNull(5000) {
		fetchUser()
	}

suspend fun main(): Unit = coroutineScope {
	val user = getUserOrNull()
	println("User: $user")
}
```

- ì¶œë ¥
    
    5ì´ˆ í›„
    
    User: null
    

## ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ ì—°ê²°í•˜ê¸°

ì„œë¡œ ë‹¤ë¥¸ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ì˜ ë‘ ê°€ì§€ ê¸°ëŠ¥ì´ ëª¨ë‘ í•„ìš”í•˜ë‹¤ë©´ ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ì—ì„œ ë‹¤ë¥¸ ê¸°ëŠ¥ì„ ê°€ì§€ëŠ” ì½”ë£¨í‹´ ìŠ¤ì½”í”„ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì•¼ í•œë‹¤. 

```kotlin
// íƒ€ì„ì•™ì›ƒê³¼ ë””ìŠ¤íŒ¨ì²˜ ëª¨ë‘ ì„¤ì •í•˜ë©´ withContext ë‚´ë¶€ì—ì„œ withTimeoutOrNullì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
suspend fun calculateAnswerOrNull(): User? = 
	withContext(Dispatchers.Default) {
		withTimeoutOrNull(1000) {
			calculateAnswer()
		}
	}
```

### ì¶”ê°€ì ì¸ ì—°ì‚°

```kotlin
class ShowUserDataUserCase(
	private val repo: UserDataRepository,
	private val view: UserDataView,
) {
	suspend fun showUserData() = coroutineScope {
		val name = async { repo.getName() }
		val friends = async { repo.getFriends() }
		val profile = async { repo.getProfile() }
		val user = User(
			name = name.await(),
			friends = friends.await(),
			profile = profile.await(),
		)
		view.show(user)
		launch { repo.notifyProfileShown() }
	}
}
```

ìœ„ ë°©ì‹ì—ì„œ ë¬¸ì œì  2ê°€ì§€

1. coroutineScopeê°€ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë³´ì—¬ì¤€ ë’¤ launchì—ì„œ í•¨ìˆ˜ì˜ ëª©ì ê³¼ ê´€ë ¨ëœ ìœ ì˜ë¯¸í•œ ì‘ì—…ì„ í•œë‹¤ê³  ë³´ê¸° ì–´ë µë‹¤. 
2. ì·¨ì†Œì˜ ë¬¸ì œ
    - ë¶„ì„ì„ ìœ„í•œ í˜¸ì¶œì´ ì‹¤íŒ¨í–ˆë‹¤ê³  í•´ì„œ ì „ì²´ ê³¼ì •ì´ ì·¨ì†Œë˜ëŠ” ë¬¸ì œ

í•µì‹¬ ë™ì‘ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ” ì¶”ê°€ì ì¸ ì—°ì‚°ì´ ìˆì„ ê²½ìš° ë˜ ë‹¤ë¥¸ ìŠ¤ì½”í”„ì—ì„œ ì‹œì‘í•˜ëŠ” í¸ì´ ë‚«ë‹¤.

```kotlin
val analyticsScope = CoroutineScope(SupervisorJob())

// ìƒì„±ìë¥¼ í†µí•´ ì£¼ì…
// ìœ ë‹› í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•  ìˆ˜ë„ ìˆê³ , ìŠ¤ì½”í”„ë¥¼ ì‚¬ìš©í•˜ëŠ”ë°ë„ í¸ë¦¬
class ShowUserDataUseCase(
	private val repo: UserDataRepository,
	private val view: UserDataView,
	private val analyticsScope: CoroutineScope,
) {
	suspend fun showUserData() = coroutineScope {
		val name = async { repo.getName() }
		val friends = async { repo.getFriends() }
		val profile = async { repo.getProfile() }
		val user = User(
			name = name.await(),
			friends = friends.await(),
			profile = profile.await(),
		)
		view.show(user)
		analyticsScope.launch { repo.notifyProfileShown() }
	}
}
```

ìŠ¤ì½”í”„ë¥¼ ì „ë‹¬í•˜ë©´ ì „ë‹¬ëœ í´ë˜ìŠ¤ë¥¼ í†µí•´ ë…ë¦½ì ì¸ ì‘ì—…ì„ ì‹¤í–‰í•œë‹¤.

â†’ ì¤‘ë‹¨ í•¨ìˆ˜ëŠ” ì£¼ì…ëœ ìŠ¤ì½”í”„ì—ì„œ ì‹œì‘í•œ ì—°ì‚°ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤.

â†’ ìŠ¤ì½”í”„ê°€ ì „ë‹¬ë˜ì§€ ì•Šìœ¼ë©´ ì¤‘ë‹¨ í•¨ìˆ˜ëŠ” ëª¨ë“  ì—°ì‚°ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì¢…ë£Œë˜ì§€ ì•ŠëŠ”ë‹¤.
