# 14ì¥ ê³µìœ  ìƒíƒœë¡œ ì¸í•œ ë¬¸ì œ

```kotlin
class UserDownloader(
	private val api: NetworkService
) {
	private val users = mutableListOf<User>()
	
	// ë°©ì–´ì  ë³µì‚¬ ì‚¬ìš©
	fun downloaded(): List<User> = users.toList()
	
	suspend fun fetchUser(id: Int) {
		val newUser = api.fetchUser(id)
		user.add(newUser)
	}
}
```

<aside>
âœ… ìœ„ ì˜ˆì œì—ì„œëŠ” downloadedë¡œ ë°˜í™˜ëœ ê°ì²´ë¥¼ ì½ì„ ë•Œì™€ ë³€ê²½ ê°€ëŠ¥í•œ ë¦¬ìŠ¤íŠ¸ì— ì›ì†Œë¥¼ ì¶”ê°€í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì¶©ëŒì„ í”¼í•˜ê¸° ìœ„í•´ ë°©ì–´ì  ë³µì‚¬ ì‚¬ìš©

usersë¥¼ ì½ê¸°ë§Œ ê°€ëŠ¥í•œ ë¦¬ìŠ¤íŠ¸(List<User>)ì™€ ì½ê³  ì“°ê¸°ê°€ ê°€ëŠ¥í•œ í”„ë¡œí¼í‹°(var)ë¡œ ì„ ì–¸í•  ìˆ˜ë„ ìˆë‹¤.
ì´ ë°©ë²•ì€ ë°©ì–´ì  ë³µì‚¬ë¥¼ í•˜ì§€ ì•Šì•„ë„ ë˜ê³  downloaded í•¨ìˆ˜ë¥¼ ë³´í˜¸í•  í•„ìš”ë„ ì—†ì§€ë§Œ, ì»¬ë ‰ì…˜ì— ì›ì†Œë¥¼ ì¶”ê°€í•˜ëŠ” ì‘ì—…ì˜ íš¨ìœ¨ì´ ë–¨ì–´ì§„ë‹¤.

í˜„ì—…ì—ì„œëŠ” ë³€ê²½ ê°€ëŠ¥í•œ ì»¬ë ‰ì…˜ì„ ì‚¬ìš©í•œë‹¤.

</aside>

ìœ„ êµ¬í˜„ì—ì„œëŠ” ë™ì‹œ ì‚¬ìš©ì— ëŒ€í•œ ëŒ€ë¹„ê°€ ë˜ì–´ ìˆì§€ ì•Šë‹¤. ê°™ì€ ì‹œê°„ì— í•´ë‹¹ í•¨ìˆ˜ê°€ í•œ ê°œì˜ ìŠ¤ë ˆë“œì—ì„œ ì‹œì‘í•  ê²½ìš°ì—ë§Œ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•œë‹¤.

ê°™ì€ ì‹œê°„ì— ë‘ ê°œ ì´ìƒì˜ ìŠ¤ë ˆë“œì—ì„œ í•¨ìˆ˜ê°€ í˜¸ì¶œë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ **usersëŠ” ê³µìœ  ìƒíƒœì— í•´ë‹¹í•˜ë©° ë³´í˜¸ë  í•„ìš”**ê°€ ìˆë‹¤.

â†’ ë™ì‹œì— ë¦¬ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•˜ë©´ ì¶©ëŒì´ ì¼ì–´ë‚  ìˆ˜ ìˆê¸° ë•Œë¬¸

```kotlin
class FakeNetworkService : NetworkService {
	override suspend fun fetchUser(id: Int): User {
		delay(2)
		return User("User$id")
	}
}

suspend fun main() {
	val downloader = UserDownloader(FakeNetworkService())
	coroutineScope {
		repeat(1_000_000) {
			launch {
				downloader.fetchUser(it)
			}
		}
	}
	print(downloader.downloaded().size) 
}
// 1000000 ë³´ë‹¤ ì‘ì€ ìˆ«ìë¥¼ ì¶œë ¥í•˜ê±°ë‚˜ ì˜ˆì™¸ë¥¼ ë˜ì§
```

```kotlin
var counter = 0

fun main() = runBlocking {
	massiveRun. {
		counter++
	}
	println(counter)
}

suspend fun massiveRun(action: suspend () -> Unit) =
	withContext(Dispatchers.Default) {
		repeat(1000) {
			launch {
				repeat(1000) { action() }
			}
		}
	}
// ê²°ê³¼ê°€ 1_000_000ì´ ì•„ë‹˜
```

(ë‹¤ì‹œ ì„¤ëª… ë¶€íƒ)

ë‘ ê°œì˜ ìŠ¤ë ˆë“œê°€ ë˜‘ê°™ì€ ì‹œê°„ì— ê°™ì€ ìˆ˜ë¥¼ 1ì”© ì¦ê°€ì‹œí‚¨ë‹¤ê³  ê°€ì •í•´ë³´ì. ì‹œì‘ê°’ì€ 0

ì²« ë²ˆì§¸ ìŠ¤ë ˆë“œê°€ í˜„ì¬ ê°’ì¸ 0ì„ ë°›ê³  ë‚œ ë’¤ í”„ë¡œì„¸ì„œê°€ ë‘ ë²ˆì§¸ ìŠ¤ë ˆë“œë¡œ ì˜®ê¸°ê¸°ë¡œ ê²°ì •

ë‘ ë²ˆì§¸ ìŠ¤ë ˆë“œ 0ì„ ë°›ê³  1ë¡œ ì¦ê°€ì‹œí‚¨ ë’¤ ë³€ìˆ˜ì— ì €ì¥

ì²« ë²ˆì§¸ ìŠ¤ë ˆë“œë¡œ ë‹¤ì‹œ ì˜®ê¸¸ ë•Œ ì´ì „ì— ë©ˆì·„ì„ ë•Œ ì‚¬ìš©í•œ 0ì„ 1ë¡œ ì¦ê°€ì‹œí‚¤ê³  ì €ì¥

â€”> ë³€ìˆ˜ê°€ 2ê°€ ë˜ì–´ì•¼í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” 1ì´ ë¨

## ë™ê¸°í™” ë¸”ë¡œí‚¹

í•´ê²° ë°©ë²•

- synchronized ë¸”ë¡
- ë™ê¸°í™”ëœ ì»¬ë ‰ì…˜ ì‚¬ìš©

```kotlin
var counter = 0

fun main() = runBlocking {
	val lock = Any()
	massiveRun {
		synchronized(lock) { // ìŠ¤ë ˆë“œë¥¼ ë¸”ë¡œí‚¹í•œë‹¤.
			counter++
		}
	}
	println("Counter = $counter")
}
```

ë¬¸ì œì 

- synchronized ë¸”ë¡ ë‚´ë¶€ì—ì„œ ì¤‘ë‹¨ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
- synchronized ë¸”ë¡ì—ì„œ ì½”ë£¨í‹´ì´ ìê¸° ì°¨ë¡€ë¥¼ ê¸°ë‹¤ë¦´ ë•Œ ìŠ¤ë ˆë“œë¥¼ ë¸”ë¡œí‚¹í•œë‹¤.
    - ì½”ë£¨í‹´ì´ ìŠ¤ë ˆë“œë¥¼ ë¸”ë¡œí‚¹í•˜ëŠ” ê²ƒì€ ì§€ì–‘í•´ì•¼í•œë‹¤.

â†’ ë¸”ë¡œí‚¹ ì—†ì´ ì¤‘ë‹¨í•˜ê±°ë‚˜ ì¶©ëŒì„ íšŒí”¼í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

## ì›ìì„±

ìë°”ì—ì„œ ê°„ë‹¨í•˜ê²Œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•

- ì›ìê°’ì„ í™œìš©í•œ ì—°ì‚° = ì›ì‚¬ì • ì—°ì‚°
    - ë¹ ë¥´ë©° â€˜ìŠ¤ë ˆë“œ ì•ˆì „â€™ì„ ë³´ì¥í•œë‹¤.
    - ë½ ì—†ì´ ë¡œìš° ë ˆë²¨ë¡œ êµ¬í˜„ë˜ì–´ íš¨ìœ¨ì ì´ê³  ì‚¬ìš©í•˜ê¸° ì‰½ë‹¤.
    - ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì›ìê°’ì˜ ì¢…ë¥˜ ë‹¤ì–‘í•˜ë‹¤.

```kotlin
private var counter = AtomicInteger()

fun main() = runBlocking {
	massiveRun {
		counter.incrementAndGet()
	}
	println(counter.get()) // 1000000
}
```

**í•˜ë‚˜ì˜ ì—°ì‚°ì—ì„œ ì›ìì„±ì„ ê°€ì§€ê³  ìˆë‹¤ê³  í•´ì„œ ì „ì²´ ì—°ì‚°ì—ì„œ ì›ìì„±ì´ ë³´ì¥ë˜ëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤.**

```kotlin
private var counter = AtomicInteger()

fun main() = runBlocking {
	massiveRun {
		counter.set(counter.get() + 1)
	}
	println(counter.get()) // 1000000ì´ ì•„ë‹˜
}
```

```kotlin
class UserDownloader(
	private val api: NetworkService
) {
	private val users = AtomicReference(listOf<User>())
	
	fun downloaded(): List<User> = users.get()
	
	suspend fun fetchUser(id: Int) {
		val newUser = api.fetchUser(id)
	
	  // ì›ìì„± ë³´ì¥ í•¨ìˆ˜
		users.getAndUpdate { it + newUser }
	}
}
```

ì›ìì„±ì€ í•˜ë‚˜ì˜ í”„ë¦¬ë¯¸í‹°ë¸Œ ë³€ìˆ˜ ë˜ëŠ” í•˜ë‚˜ì˜ ë ˆí¼ëŸ°ìŠ¤ì˜ ì•ˆì „ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ì§€ë§Œ, ì¢€ë” ë³µì¡í•œ ê²½ìš°ì—ëŠ” ë‹¤ë¥¸ ë°©ë²•ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

## ì‹±ê¸€ìŠ¤ë ˆë“œë¡œ ì œí•œëœ ë””ìŠ¤íŒ¨ì²˜

ì‹±ê¸€ìŠ¤ë°ë¥´ ë””ìŠ¤íŒ¨ì²˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê³µìœ  ìƒíƒœì™€ ê´€ë ¨ëœ ëŒ€ë¶€ë¶„ì˜ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

```kotlin
val dispatcher = Dispatcher.IO
	.limitedParallelism(1)

var counter = 0

fun main() = runBlocking {
	massiveRun {
		withContext(dispatcher) {
			counter++
		}
	}
	println(counter) // 1000000
}
```

**ë””ìŠ¤íŒ¨ì²˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ë‘ ê°€ì§€ ë°©ë²•**

- ì½”ìŠ¤ ê·¸ë ˆì¸ë“œ ìŠ¤ë ˆë“œ í•œì •(coarse-grained thread confinement)
    - ë””ìŠ¤íŒ¨ì²˜ë¥¼ ì‹±ê¸€ ìŠ¤ë ˆë“œë¡œ ì œí•œí•œ withContextë¡œ ì „ì²´ í•¨ìˆ˜ë¥¼ ë˜í•‘í•˜ëŠ” ë°©ë²•
    - ì‚¬ìš©í•˜ê¸° ì‰¬ìš°ë©° ì¶©ëŒ ë°©ì§€ í•  ìˆ˜ ìˆë‹¤.
    - í•¨ìˆ˜ ì „ì²´ì—ì„œ ë©€í‹° ìŠ¤ë ˆë”©ì˜ ì´ì ì„ ëˆ„ë¦¬ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ìˆë‹¤.
    
    ```kotlin
    class UserDownloader(
    	private val api: NetworkService,
    ) {
    	private val users = mutableListOf<User>()
    	private val dispatcher = Dipatchers.IO
    		.limitedParallelism(1)
    		
    	suspend fun downloaded(): List<User> =
    		withContext(dispatcher) = 
    			users.toList()
    		}
    		
    	suspend fun fetchUser(id: Int) = withContext(dispatcher) {
    		val newUser = api.fetchUser(id)
    		users += newUser
    	}
    }
    
    /*
    api.fetcherUser(id)ëŠ” ì—¬ëŸ¬ ê°œì˜ ìŠ¤ë ˆë“œì—ì„œ ë³‘ë ¬ë¡œ ì‹œì‘í•  ìˆ˜ ìˆì§€ë§Œ í•¨ìˆ˜ ë³¸ì²´ëŠ” 
    ì‹±ê¸€ìŠ¤ë ˆë“œë¡œ ì œí•œëœ ë””ìŠ¤íŒ¨ì²˜ì—ì„œ ì‹¤í–‰ëœë‹¤.
    -> ë¸”ë¡œí‚¹ë˜ëŠ” í•¨ìˆ˜ ë˜ëŠ” CPU ì§‘ì•½ì ì¸ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ í•¨ìˆ˜ ì‹¤í–‰ì´ ëŠë ¤ì§„ë‹¤.
    ```
    

- íŒŒì¸ ê·¸ë ˆì¸ë“œ ìŠ¤ë ˆë“œ í•œì •(fine-grained thread confinement)
    - ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” êµ¬ë¬¸ë“¤ë§Œ ë˜í•‘í•œë‹¤.
    - ì¢€ ë” ë²ˆê±°ë¡­ì§€ë§Œ critical section(ê³µìœ  ìì› ì ‘ê·¼ ìˆœì„œì— ë”°ë¼ ì‹¤í–‰ ê²°ê³¼ê°€ ë‹¬ë¼ì§€ëŠ” í”„ë¡œê·¸ë¨ì˜ ì½”ë“œ ì˜ì—­)ì´ ì•„ë‹Œ ë¶€ë¶„ì´ ë¸”ë¡œí‚¹ë˜ê±°ë‚˜ CPU ì§‘ì•½ì ì¸ ê²½ìš°ì— ë” ë‚˜ì€ ì„±ëŠ¥ì„ ì œê³µí•œë‹¤.
    - ì¼ë°˜ì ì¸ ì¤‘ë‹¨ í•¨ìˆ˜ì— ì ìš©í•˜ëŠ” ê²½ìš°ì—ëŠ” ì„±ëŠ¥ì— í° ì°¨ì´ê°€ ì—†ë‹¤.
    
    ```kotlin
    class UserDownloader(
    	private val api: NetworkService
    ) {
    	private val users = mutableListOf<User>()
    	private val dispatcher = Dispatchers.IO
    		.limitedParalleism(1)
    		
    	suspend fun downloaded(): List<User> = 
    		withContext(dispatcher) {
    			users.toList()
    		}
    		
    	suspend fun fetchUser(id: Int) {
    		val newuser = api.fetchUser(id)
    		withContext(dispatcher) {
    			users += newUser
    		}
    	}
    }
    ```
    

ëŒ€ë¶€ë¶„ì˜ ê²½ìš°, í‘œì¤€ ë””ìŠ¤íŒ¨ì²˜ê°€ ê°™ì€ ìŠ¤ë ˆë“œ í’€ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ì‹±ê¸€ìŠ¤ë ˆë“œë¥¼ ê°€ì§„ ë””ìŠ¤íŒ¨ì²˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê±´ ì‰¬ìš¸ ë¿ ì•„ë‹ˆë¼ íš¨ìœ¨ì ì´ë‹¤.(?)

## ë®¤í…ìŠ¤

ê°€ì¥ ì¤‘ìš”í•œ ê¸°ëŠ¥ì€ **lock**

ë‹¨ í•˜ë‚˜ì˜ ì—´ì‡ ê°€ ìˆëŠ” ë°©, í™”ì¥ì‹¤ì´ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤.

â†’ ë‹¨ í•˜ë‚˜ì˜ ì½”ë£¨í‹´ë§Œì´ lockê³¼ unlock ì‚¬ì´ì— ìˆì„ ìˆ˜ ìˆë‹¤.

```kotlin
suspend fun main() = coroutineScope {
	repeat(5) {
		launch {
			delayAndPrint()
		}
	}
}

val mutex = Mutex()

suspend fun delayAndPrint() {
	mutex.lock()
	delay(1000)
	println("Done")
	mutext.unlock()
}
// 1ì´ˆ í›„
// Done
// 1ì´ˆ í›„
// Done
// 1ì´ˆ í›„
// Done
// 1ì´ˆ í›„
// Done
// 1ì´ˆ í›„
// Done
```

lockê³¼ unlockì„ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ìœ„í—˜í•˜ë‹¤

â†’ ë‘ í•¨ìˆ˜ ì‚¬ì´ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•  ê²½ìš°(ë˜ëŠ” ë°˜í™˜ì´ ë¹ ë¥´ê²Œ ì´ë¤„ì§ˆ ê²½ìš°) ì—´ì‡ ë¥¼ ëŒë ¤ë°›ì„ ìˆ˜ ì—†ë‹¤(unlockì´ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.)

â†’ ë‹¤ë¥¸ ì½”ë£¨í‹´ì´ lockì„ í†µê³¼í•  ìˆ˜ ì—†ë‹¤.

â†’ ì´ëŠ” ë°ë“œë½ í˜„ìƒì„ ì•¼ê¸°í•œë‹¤.(ëˆ„êµ°ê°€ ë„ˆë¬´ ê¸‰í•´ ì—´ì‡ ë¥¼ ëŒë ¤ì£¼ëŠ” ê²ƒì„ ìŠëŠ” ë°”ëŒì— í™”ì¥ì‹¤ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ìƒí™©)

<aside>
ğŸ’¡ **ë°ë“œë½**
ë‘ ê°œ ì´ìƒì˜ ì‘ì—…ì´ ì„œë¡œ ìƒëŒ€ë°©ì˜ ì‘ì—…ì´ ëë‚˜ê¸° ë§Œì„ ê¸°ë‹¤ë¦¬ê³  ìˆê¸° ë•Œë¬¸ì— ê²°ê³¼ì ìœ¼ë¡œ ì•„ë¬´ê²ƒë„ ì™„ë£Œë˜ì§€ ëª»í•˜ëŠ” ìƒíƒœ

</aside>

**withLock í•¨ìˆ˜ ì‚¬ìš©**

- lockìœ¼ë¡œ ì‹œì‘í•´ finally ë¸”ë¡ì—ì„œ unlock í˜¸ì¶œ
- ë¸”ë¡ ë‚´ì—ì„œ ì–´ë–¤ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë”ë¼ë„ ìë¬¼ì‡ ë¥¼ ì„±ê³µì ìœ¼ë¡œ í’€ ìˆ˜ ìˆë‹¤.
- ì‹¤ì œ ì‚¬ìš©ë²•ì€ synchronized ë¸”ë¡ê³¼ ë¹„ìŠ·

```kotlin
val mutext = Mutext()

var counter = 0

fun main() = runBlocking {
	massiveRun {
		mutex.withLock {
			counter++
		}
	}
	println(counter) // 1000000
}
```

**ë®¤í…ìŠ¤ì˜ ì´ì **

- ìŠ¤ë ˆë“œë¥¼ ë¸”ë¡œí‚¹í•˜ëŠ” ëŒ€ì‹  ì½”ë£¨í‹´ì„ ì¤‘ë‹¨ì‹œí‚¨ë‹¤.
    - ì¢€ ë” ì•ˆì „í•˜ê³  ê°€ë²¼ìš´ ë°©ì‹
    - ë³‘ë ¬ ì‹¤í–‰ì´ ì‹±ê¸€ìŠ¤ë ˆë“œë¡œ ì œí•œëœ ë””ìŠ¤íŒ¨ì²˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒê³¼ ë¹„êµí•˜ë©´ ë®¤í…ìŠ¤ê°€ ê°€ë³ê³  ì¢€ ë” ë‚˜ì€ ì„±ëŠ¥

**ë®¤í…ìŠ¤ ë¬¸ì œì **

- ì½”ë£¨í‹´ì´ ë½ì„ ë‘ ë²ˆ í†µê³¼í•  ìˆ˜ ì—†ë‹¤. (ì—´ì‡ ê°€ ë¬¸ ì•ˆìª½ì— ìˆìœ¼ë©´ ê°™ì€ ì—´ì‡ ë¥¼ í•„ìš”ë¡œ í•˜ëŠ” ë˜ ë‹¤ë¥¸ ë¬¸ì„ í†µê³¼í•  ìˆ˜ ì—†ëŠ” ê²ƒê³¼ ë¹„ìŠ·í•˜ë‹¤)

```kotlin
suspend fun main() {
	val mutex = Mutex()
	println("Started")
	mutex.withLock {
		mutex.withLock {
			println("Will never be printed")
		}
	}
}
// Started
// ì˜ì›íˆ ì‹¤í–‰ëœë‹¤.

-> êµì°© ìƒíƒœì— ë¹ ì§€ê²Œ ë˜ë©° ì˜ì›íˆ ë¸”ë¡œí‚¹ëœ ìƒíƒœë¡œ ìˆê²Œ ëœë‹¤.
```

- ì½”ë£¨í‹´ì´ ì¤‘ë‹¨ë˜ì—ˆì„ ë•Œ ë®¤í…ìŠ¤ë¥¼ í’€ ìˆ˜ ì—†ë‹¤.

```kotlin
class MessageRepository {
	private val messages = mutableListOf<String>()
	private val mutex = Mutex()
	
	suspend fun add(message: String) = mutex.withLock {
		delay(1000) // ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œì´ë¼ ê°€ì •
		messages.add(message)
	}
}

suspend fun main() {
	val repo = MeaagesRepository()
	
	val timeMillis = measureTimeMillis {
		coroutineScope {
			repeat(5) {
				launch {
					repo.add("Message$it")
				}
			}
		}
	}
	println(timeMillis) // 5ì´ˆ ì •ë„ ê±¸ë¦¼
}
```

â†’ ì‹±ê¸€ìŠ¤ë ˆë“œë¡œ ì œí•œëœ ë””ìŠ¤íŒ¨ì²˜ë¥¼ ì‚¬ìš©í•˜ë©´ delayë‚˜ ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œì´ ì½”ë£¨í‹´ì„ ì¤‘ë‹¨ì‹œí‚¤ë©´ ìŠ¤ë ˆë“œë¥¼ ë‹¤ë¥¸ ì½”ë£¨í‹´ì´ ì‚¬ìš©í•œë‹¤.

```kotlin
class MessageRepository {
	private val messages = mutableListOf<String>()
	private val dispatcher = Dispatcher.IO
		.limitedParallelism(1)
	
	suspend fun add(message: String) = withContext(dispatcher) {
		delay(1000) // ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œì´ë¼ ê°€ì •
		messages.add(message)
	}
}

suspend fun main() {
	val repo = MeaagesRepository()
	
	val timeMillis = measureTimeMillis {
		coroutineScope {
			repeat(5) {
				launch {
					repo.add("Message$it")
				}
			}
		}
	}
	println(timeMillis) // 5ì´ˆ ì •ë„ ê±¸ë¦¼
}
```

â†’ ì „ì²´ í•¨ìˆ˜ë¥¼ ë®¤í…ìŠ¤ë¡œ ë˜í•‘í•˜ëŠ” ê²ƒì€ ì§€ì–‘í•´ì•¼ í•œë‹¤.(ì½”ìŠ¤ ê·¸ë ˆì¸ë“œ ë°©ì‹)

â†’ ë®¤í…ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë½ì„ ë‘ ë²ˆ ê±¸ì§€ ì•Šê³  ì¤‘ë‹¨ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šë„ë¡ í•´ì•¼í•œë‹¤.

- ì‹±ê¸€ ìŠ¤ë ˆë“œë¡œ ì œí•œëœ ë””ìŠ¤íŒ¨ì²˜ ì‚¬ìš©
- (ê³µìœ  ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” ê³³ì—ì„œë§Œ ë˜í•‘í•˜ëŠ”) íŒŒì¸ ê·¸ë ˆì¸ë“œ ìŠ¤ë ˆë“œ í•œì •ì´ ë„ì›€ì´ ë  ìˆ˜ ìˆë‹¤.

## ì„¸ë§ˆí¬ì–´

**Semaphore**

- ì—¬ëŸ¬ ê°œì˜ ì ‘ê·¼ì„ í—ˆìš©
- acquire, release, withPermit í•¨ìˆ˜ë¥¼ ê°€ì§€ê³  ìˆë‹¤.

```kotlin
suspend fun main() = coroutineScope {
	val semaphore = Semaphore(2)
	
	repeat(5) {
		launch {
			semaphore.withPermit {
				delay(1000)
				println(it)
			}
		}
	}
}

// 01
// 1ì´ˆ í›„
// 23
// 1ì´ˆ í›„
// 4
```

- ê³µìœ  ìƒíƒœë¡œ ì¸í•´ ìƒê¸°ëŠ” ë¬¸ì œ í•´ê²° í•  ìˆ˜ ì—†ì§€ë§Œ, ë™ì‹œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ìˆ˜ë¥¼ ì œí•œí•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ **ì²˜ë¦¬ìœ¨ ì œí•œ ì¥ì¹˜(rate limiter)** êµ¬í˜„í•  ë•Œ ë„ì›€ì´ ëœë‹¤.

```kotlin
class LimitedNetworkUserRepository(
	private val api: UserApi
) {
	// ë™ì‹œ ìš”ì²­ì„ 10ê°œë¡œ ì œí•œí•œë‹¤.
	private al semaphore = Semaphore(10)
	
	suspend fun requestUser(userId: String) =
		semaphore.withPermit {
			api.requestUser(userId)
		}
}
```

### ìš”ì•½

**ê³µìœ  ìƒíƒœë¥¼ ë³€ê²½í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì¶©ëŒì„ í”¼í•˜ê¸° ìœ„í•œ ë°©ë²•**

- ì‹±ê¸€ìŠ¤ë ˆë“œë¡œ ì œí•œëœ ë””ìŠ¤íŒ¨ì²˜ë¥¼ ì‚¬ìš©í•´ ê³µìœ  ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒ
- ë™ê¸°í™”ê°€ í•„ìš”í•œ íŠ¹ì • ì¥ì†Œë§Œ ë˜í•‘í•˜ëŠ” íŒŒì¸ ê·¸ë ˆì¸ë“œ ìŠ¤ë ˆë“œ í•œì •
- ì „ì²´ í•¨ìˆ˜ë¥¼ ë˜í•‘í•˜ëŠ” ì½”ìŠ¤ ê·¸ë ˆì¸ë“œ ìŠ¤ë ˆë“œ í•œì •
- ì½”ìŠ¤ ê·¸ë ˆì¸ë“œê°€ ë” ì‰½ì§€ë§Œ ì„±ëŠ¥ì´ ë–¨ì–´ì§„ë‹¤.
- ì›ìê°’ì´ë‚˜ ë®¤í…ìŠ¤ ì‚¬ìš©
