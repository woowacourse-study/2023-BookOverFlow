# 4장 | 프로그램의 구조와 실행

## 1. 프로그램의 구조와 인터럽트

- 프로그램이 CPU에서 명령을 수행하려면 해당 명령을 담은 프로그램의 주소 영역이 메모리에 올라가 있어야 한다.
- 프로그램의 주소영역은 크게 코드, 데이터, 스택 영역으로 구분된다.
- 코드 - 우리가 작성한 프로그램 함수들의 코드가 기계어 명령으로 형태가 변환되어 저장되어 있는 부분
- 데이터 - 전역 변수 등 프로그램이 사용하는 데이터를 저장하는 부분
- 스택 - 함수가 호출될 때 호출된 함수의 수행을 마치고 복귀할 주소 및 데이터를 임시로 저장하는데 사용하는 공간
- 인터럽트의 원리도 함수의 호출과 비슷하다.
- 인터럽트 때문에 CPU를 빼앗긴 위치는 운영체제가 관리하는 프로세스 제어블록에 저장된다.

## 2. 컴퓨터 시스템의 작동 개요

- CPU는 매 시점 메모리의 특정 주소에 존재하는 명령을 하나씩 읽어와 그대로 실행한다.
- CPU가 수행해야 할 메모리 주소를 담고 있는 레지스터를 프로그램 카운터라고 부른다.
- CPU가 수행하는 명령
    - 일반명령 - 메모리에서 자료를 읽어와 CPU에서 계산하고 결과를 메모리에 쓰는 일련의 명령들을 말하는데, 이러한 일반명령은 모든 프로그램이 수행할 수 있는 명령이다.
    - 특권명령 - 보안이 필요한 명령으로 입출력 장치, 타이머 등 각종 장치에 접근하는 명령이다.
    - 사용자 프로그램이 실행되다 보면 특권명령이 수행이 필요한 경우가 있는데, 이땐 운영체제에게 대행을 요청한다. → 시스템 콜이라고 부른다.

## 3. 프로그램의 실행

- 프로그램의 실행
    1. 디스크에 존재하던 실행파일이 메모리에 적재된다.
    2. 프로그램이 CPU를 할당받고 명령을 수행하고 있는 상태라는 의미이다.
- 프로그램마다 독자적으로 존재하는 이와 같은 주소 공간을 우리는 가상메모리 또는 논리적 메모리라고 부른다.
- 커널의 데이터 영역에는 각종 자원을 관리하기 위한 자료구조가 저장된다. CPU나 메모리와 같은 하드웨어 자원을 관리하기 위한 자료구조뿐 아니라 현재 수행 중인 프로그램을 관리하기 위한 자료구조도 커널의 데이터 영역에 유지된다.
- 프로세스(process) - 현재 실행 중인 프로그램을 뜻함

## 4. 사용자 프로그램이 사용하는 함수

프로그램이 사용하는 함수

- 사용자 정의함수 - 프로그래머가 직접 작성한 함수
- 라이브러리 함수 - 이미 누군가 작성해 놓은 함수를 호출만 하여 사용
- 커널함수 - 운영체제 커널의 코드에 정의된 함수
    - 시스템콜 - 사용자 프로그램이 운영체제의 서비스를 요청하기 위해 호출하는 함수
    - 인터럽트 처리 함수 - 각종 하드웨어 및 소프트웨어가 CPU의 서비스를 요청하기 위해 발생시킴

## 5. 인터럽트

- 현재 수행중인 프로세스로부터 CPU를 회수해 CPU가 다른 일을 수행하도록 하기 위해서 필요한 매커니즘
- 인터럽트 처리 중에 또 다른 인터럽트가 발생하는 경우?
    - 원칙적으로는 중복적으로 인터럽트가 발생하는 걸 허용하지 않는다.
    - 데이터의 일관성이 유지되는 않는 문제가 발생할 수 있기 때문이다.
    - 예외 - 인터럽트마다 중요도가 다르기 때문에 상대적으로 낮은 중요도를 가진 인터럽트를 처리하는 도중에 중요도가 더 높은 인터럽트가 발생하는 것을 허락할 필요가 있다.
    - 마찬가지로 이 경우에도 중요도 높은 인터럽트를 처리하고 나면 원래 처리하던 인터럽트 처리를 마저 한다.

## 6. 시스템 콜

- 시스템 콜 - 자신의 프로그램이 아닌, 커널이라는 다른 프로그램의 주소 공간에 존재하는 함수를 호출하는 것이다.
- 일반적인 함수호출이 자신의 스택에 복귀 주소를 저장한 후 호출된 함수 위치로 점프하는 것임에 비해, 시스템 콜은 주소 공간 자체가 다른 곳으로 이동해야 하므로 방법이 다른다.
- 프로그램 자신이 인터럽트 라인에 인터럽트를 세팅하는 명령을 통해 이루어진다.
- 프로그램이 스스로 인터럽트 라인을 세팅한다는 점만 다를 뿐 일반적인 인터럽트의 발생과 동일한 방법이라 할 수 있다.
- 대부분의 운영체제는 입출력을 요청한 다음 CPU의 제어권을 다른 프로세스에게 이양한다.
- 프로그램이 CPU를 할당 받고 명령을 수행하다가 중간에 CPU를 빼았기는 경우 두 가지
    1. 타이머에 의해 인터럽트가 발생하는 경우
    2. 입출력 요청을 위해 시스템 콜을 하는 경우

## 7. 프로세스의 두 가지 실행 상태

- 사용자모드에서의 실행상태 - 자신의 주소 공간에 정의된 코드를 실행하는 것
- 커널모드에서의 실행상태 - 커널의 시스템 콜 함수를 실행하는 것
- 프로그램이 사용자 정의함수나 라이브러리 함수를 호출할 때에는 모드 변경 없이 사용자 모드에서 실행을 지속하고, 시스템콜을 하는 경우에는 커널모드로 진입해 커널의 주소 공간에 정의된 함수를 실행하게 된다.
  시스템 콜의 실행이 끝나면 다시 사용자모드로 복귀해서 시스템 콜 이후의 명령들을 계속 실행한다.
  프로그램의 실행이 끝날 때에는 커널모드로 진입해 프로그램을 종료한다.
